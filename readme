rm-viewer is a software to sync the contents of your reMarkable and view it
from a web UI.
 - It automatically syncs changes from your reMarkable as you use it.
 - It does handwriting recongition on your handwriting, and creates PDFs with
   overlayed invisible text, allowing you to search and copy your handwriting.
 - It allows you to search all your notes.
 - The viewer is created to look great on a mobile phone.

The following install instructions are tested on python3.12 and python3.14, on
Ubuntu 24 and macOS.

Install rsync.

Install google chrome:
$ curl -LO https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
$ apt install -y ./google-chrome-stable_current_amd64.deb

For handwriting recongition, create a file called 'gcv_api_key' with your
Google Cloud Vision API key in this directory.
Use the scripts in debug/ to test your key and make sure it works.

We have to use the legacy pip resolver to ignore some dependency conflicts that
aren't actually conflicts while installing rm-viewer.
$ python3 -m .venv venv
$ source .venv/bin/activate
$ pip install --use-deprecated=legacy-resolver -r requirements.txt

Set up sync folder (in rm-viewer directory):
$ python3 -m rm_viewer syncd --install sync
Note down the value it says to set SYNC_DIR to.

Copy the device installation template directory
$ cp -r .rm-viewer rm-viewer-install
In the new folder (rm-viewer-install), fill in config.sh. You may want to set:
  - REMOTE_USER and REMOTE_HOST (current user and hostname/ip)
  - SYNC_DIR (full path of sync folder)
  - RSYNC_REMOTE (path to rsync binary)
  - DEBOUNCE is shortest interval between the device doing syncs, change if
    needed.

Now, let's do an initial manual sync.

Do an initial copy of your xochitl  directory (this is where your reMarkable
files are stores) to the sync directory. Probably best to do this over the usb
connection.

ssh into your reMarkable and run:
$ rsync -av \
    --partial-dir .rsync-partial \
    --no-compress \
    --delete-delay \
    --info=progress2,stats1 \
    --rsync-path=/opt/homebrew/bin/rsync \
    --exclude='*.thumbnails/***' \
    -e 'ssh -i /home/root/key' \
    /home/root/.local/share/remarkable/xochitl/ \
    user@remote:/home/bigdog/remarkable/rm-viewer/sync/xochitl-dirty/
If you want to create an ssh key, run:
$ dropbearkey -f /home/root/key
Delete the key afterwards as we will set up another one as part of the
installation on the device.

Then on the remote, run this (indicates to rm-viewer that we have files needing
to be processed):
$ touch sync/syncflag

Now, let's run an initial process of the files, and test the webUI.

This command processes the xochitl directory and buidls a search index,
generates thumbnails and does OCR, and stores the results in
sync/stable/process_out. Chrome emits a lot of warnings/errors, but they can be
ignored.

This may take a while (1hr40 minutes for me), on the first process. Every
subsequent processing run is incremental and so should be much quicker.

$ python3 -m rm_viewer processor sync/xochitl-dirty sync/stable/process_out

Now, start the viewer. You should be able to visit the website and browse your
files. I start it on localhost, and then use nginx to proxy to it (and serve on
https). Serving on https allows the pdf viewer to copy text, http doesn't allow
this.

$ python3 -m rm_viewer view sync/stable/process_out --host 127.0.0.1 --port 8080

Once you've verified this, now let's install install rm-viewer on the
reMarkable, so that it automatically syncs changes. Once you're happy with the
config values in rm-viewer-install, copy the directory to /home/root/.rm-viewer
on the device.
$ scp -r rm-viewer-install root@<tablet-ip>:/home/root/.rm-viewer

We will run the sync script manually once, to test it works.

Then, on the device, manually create a ssh key:
$ cd .rm-viewer
$ source ./config.sh
$ dropbearkey -f "$SSH_KEY"
Then copy the public key (will be in the .pub file of the key just generated)
and put it in the remote ~/.ssh/authorized_keys files.

Do a test ssh to your remote (ssh -i rm-viewer-sync-key user@remote). Don't
worry, we will restrict the key to only sync later.

On the remote, make sure the viewer is still running (the rm_viewer view
command). Then start the rm-viewer sync daemon, on the sync directory and with
the url of the running viewer. It needs this url as it will hit an endpoint on
the viewer to reload its index when new processed output is available.

$ python3 -m rm_viewer syncd sync --viewer-url http://127.0.0.1:8080

Back on the tablet, run ./sync.sh.
Then make a change on the tablet. You should see it detect the change and do an
rsync to the remote. You should then see the running syncd pick up the rsync
and re-process the files. Syncd should then send a request to the viewer to
rebuild its index. Your open web viewer should then automatically reload and
show you the change.

If this is all work, kill sync.sh. You may need to kill -9 it and the running
inotify process.

Now, run these commands to run a persistent systemd service that runs this sync
script.

First, unmount the etc overlay.
$ umount -R /etc

Next, mount the system as writeable.
$ mount -o remount,rw /

Then, run the install.sh.
$ ./install.sh

Now, remount root as read-only.
$ mount -o remount,ro /

To see the sync script output, run:
$ journalctl -fu rm-viewer-sync

Test rebooting your reMarkable and seeing that the syncing works.
